# 범주형 데이터 전처리
- 사이킷런은 숫자형만 처리할 수 있다.

## 범주형 변수(Categorical Variable)
- 어떤 분류에 대한 속성을 가지는 변수
  - ex) 성별 - 남/녀, 혈액형 - A, B, AB, O, 성적 - A, B, C, D, F
- 비서열(Unordered) 변수
  - 범주에 속한 값간에 **서열(순위)가 없는 변수**
  - 성별, 혈액형
- 서열(Ordered) 변수
  - 범주에 속한 값 간에 **서열(순위)가 있는 변수**
  - 성적, 직급
- 사이킷런은 문자열 값을 숫자 형으로 변환해야 한다.
  - 범주형 변수 => **정수값**으로 변환
  - 단순 문자열(범주형X) => 일반적으로 **제거**
## 범주형 Feature의 처리
- Label Encoding
- One Hot Encoding

# 1. 레이블 인코딩(Label Encoding)
- 문자열(범주형) 값을 오름차순 정렬 후 0부터 1씩 증가하는 값으로 변환
- 숫자의 차이가 모델에 영향을 주지 않는 트리 계열 모델(**의사결정나무, 랜덤포레스트**)에 적용
- ![image](https://user-images.githubusercontent.com/77317312/111961838-e155f800-8b34-11eb-8067-cde647b99db6.png)
- `sklearn.preprocessing.LabelEncoder` 사용
  - `fit()` : 어떻게 변환할 지 학습
  - `transform()` : 문자열을 숫자로 변환
  - `fit_transform()` : 학습과 변환을 한번에 처리
  - `inverse_transform()` : 숫자를 문자열로 변환
  - `classes_` : 인코딩한 클래스 조회
## Label_Encoding 실습
- adult data에 label encoding 적용
- 데이터셋은 1994년 인구조사 데이터 베이스에서 추출한 미국 성인의 소득 데이터셋
- target은 income이며 수입이 $50,000 이하인지 초과인지로 분류되어 있음
- https://archive.ics.uci.edu/ml/datasets/adult
```python
import pandas as pd

# 데이터 불러와서 정리
cols = ['age', 'workclass','fnlwgt','education', 'education-num', 'marital-status', 'occupation','relationship', 'race', 'gender','capital-gain','capital-loss', 'hours-per-week','native-country', 'income']
adult = pd.read_csv('data/adult.data',
                    header=None, # 컬럼명 지정 안함
                    names=cols,  # 직접 컬럼명 지정
                    skipinitialspace=True, # 데이터의 앞뒤 공백 제거
                    na_values='?') # nan이 아닌 값 nan처리
adult.dropna(inplace=True) # 결측치 처리

encoding_columns = ['workclass','education','marital-status', 'occupation','relationship','race','gender','native-country', 'income']
not_encoding_columns = ['age','fnlwgt', 'education-num','capital-gain','capital-loss','hours-per-week']
                    
from sklearn.preprocessing import LabelEncoder

# 각  컬럼(feature)마다 변환 전의 고유값들을 저장할 딕셔너리
enc_dict = {}

# apply에 넣어줄 함수 정의
def encoding_label(x):
  # 범주형 Series를 매개변수로 받아 LabelEncoding 처리 후 반환
  le = LabelEncoder()
  ret = le.fit_transform(x)
  enc_dict[x.name] = le.classes_ # x.name : 컬럼명 조회
  return ret

adult_enc_df = adult[encoding_columns].apply(encoding_label)
adult_enc_df
```
- ![image](https://user-images.githubusercontent.com/77317312/111968449-80322280-8b3c-11eb-9946-8fcaeb3646b2.png)
```python
# 변환한 값의 고유값 알아보기
enc_dict['workclass'][5], enc_dict['occupation'][3]
# ('State-gov', 'Exec-managerial')

# 변환하지 않은 컬럼 붙여주기
adult_df = pd.concat([adult_enc_df, adult[not_encoding_columns]], axis=1)
```
## 학습하기
```python
from sklearn.model_selection import train_test_split
from sklearn.tree import DecisionTreeClassifier

# 데이터 셋 분리
# 1. income(y) 분리
y = adult_df['income']
X = adult_df.drop(colums='income')

# 2. train, validation, test set으로 분리
# test set 분리
X_train, X_test, y_train, y_test = train_test_split(X, y, test_size=0.2, stratify=y, random_state=1)

X_train, X_val, y_train,  y_val = train_test_split(X_train, y_train, test_size=0.2, stratify=y, random_state=1)

# 3. 모델 생성 및 학습
from sklearn.tree import DecisionTreeClassifier

tree = DecisionTreeClassifier(max_depth=7, random_state=1)
tree.fit(X_train, y_train)

# 4. 검증
from sklearn.metrics import accuracy_score

pred_train = tree.predict(X_train)
pred_val = tree.predict(X_val)

print('train 정확도 :', accuracy_score(y_train, pred_train))
print('val 정확도 :', accuracy_score(y_val, pred_val))
# train 정확도 : 0.8585875331564987
# val 정확도 : 0.8509862423338306

# test set으로 최종 평가
pred_test = tree.predict(X_test)
print('test accuracy :', accuracy_score(y_test, pred_test))
# test accuracy : 0.8508204873197415
```
# 2. 원핫 인코딩(One-Hot Encoding)
- n개의 클래스를 n 차원의 One-Hot 벡터로 표현되도록 변환
  - 고유값들을 feature로 만들고 정답에 해당하는 열은 1, 나머지는 0으로 표시
- 숫자의 차이가 모델에 영향을 미치는 선형 계열 모델(로지스틱회귀, SVM, 신경망)에서 범주형 데이터 변환시 사용
- ![image](https://user-images.githubusercontent.com/77317312/111986280-16704380-8b51-11eb-839a-7bb8a5eb0185.png)
- **사이킷런**
  - `sklearn.preprocessing.OneHotEncoder` 이용
    - `fit()` : 어떻게 변환할 지 학습
    - `transform()` : 문자열를 숫자로 변환
    - `fit_transform()` : 학습과 변환 한번에 처리
    - `get_feature_names()` : 원핫인코딩으로 변환된 컬럼의 이름 반환
  - DataFrame을 넣을 경우 모든 변수들을 변환
    - 범주형 컬럼만 처리하도록 해야한다.
- **Pandas**
  - `pandas.get_dummies(DataFrame [, columns=[변환할 컬럼명]])` 함수 이용
  - DataFrame에서 범주형(문자열) 변수만 변환한다.
## adult dataset에 One-Hot Encoding 적용
```python
import pandas as pd
cols = ['age', 'workclass','fnlwgt','education', 'education-num', 'marital-status', 'occupation','relationship', 'race', 'gender','capital-gain','capital-loss', 'hours-per-week','native-country', 'income']

# 데이터 생성
data = pd.read_csv('data/adult.data',
                    header=None,
                    names=cols,
                    skipinitialspace=True,
                    na_values='?')
# 결측치 제거
data.droupna(inplace=True)
```
- 범주형: 'workclass','education', 'education-num', 'marital-status', 'occupation','relationship', 'race', 'gender', 'hours-per-week','native-country', 'income'
- 연속형: 'age', fnlwgt', 'capital-gain', 'capital-loss'
- **위의 컬럼들중 'workclass','education', 'occupation', 'gender', 'hours-per-week', 'income' 만 사용한다.**
- **income 은 Label Encoding으로 처리한다.**
    - output 데이터
```python
categorical_cols = ['workclass','education', 'occupation', 'gender', 'hours-per-week', 'income']
adult_df = data[categorical_cols]
   
from sklearn.preprocessing import LabelEncoder, OneHotEncoder

# income 컬럼은 LabelEncoding
le = LabelEncoder()
y = le.fit_transform(adult_df['income'])

# 나머지 컬럼 OneHotEncoding
ohe = OneHotEncoder(sparse=False)
X = ohe.fit_transform(adult_df[adult_df.columns[:-2]])

# 데이터 프레임으로 변환
X_df = pd.DataFrame(X, columns=ohe.get_feature_names())
X_df['hours-per-week'] = adult_df['hours-per-week'].values
## 그냥 붙이게 되면 인덱스 값이 다르게 때문에 nan값이 발생  주의하자
```
## 판다스의 pd.get_dummies() 사용
```python
pd.get_dummies(adult_df.drop(columns='income'))
# 한줄로 끝...
```
## 데이터 학습
```python
from sklearn.preprocessing import train_test_split

# train, test set 분리
X_train, X_test, y_train, y_test = train_test_split(X_df, y, test_size=0.3, stratify=y, random_state=1)

# 모델 생성 및 학습
from sklearn.linear_model import LogisticRegression # 선형모델
from sklearn.metrics import accuracy_score

lr = LogisticRegression(max_iter=1000)
lr.fit(X_train, y_train)

## 검증
pred_train = lr.predict(X_train)
pred_test = lr.predict(X_test)
print('train accuracy :', accuracy_score(y_train, pred_train))
print('test accuracy :', accuracy_score(y_test, pred_test))
# train accuracy : 0.9835680751173709
# test accuracy : 0.972027972027972
```






















